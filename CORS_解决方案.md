# CORS 连接问题解决方案

## 问题描述
当前端页面从局域网地址（如 `http://192.168.0.160:3000`）访问后端API时，遇到CORS跨域错误：
```
Access to fetch at 'http://127.0.0.1:5000/ping' from origin 'http://192.168.0.160:3000' has been blocked by CORS policy
```

## 解决方案

### 1. 已实施的修复
- ✅ 更新了后端 `backend/api_server.py` 中的CORS配置
- ✅ 实现了动态CORS验证，自动支持局域网地址
- ✅ 改进了前端错误诊断和日志记录

### 2. 自动支持的地址范围
新的CORS配置自动支持以下地址：
- `http://localhost:3000` 和 `http://127.0.0.1:3000`
- `http://localhost:5000` 和 `http://127.0.0.1:5000`
- 局域网段：`192.168.x.x:3000`
- 局域网段：`10.x.x.x:3000`
- 局域网段：`172.16-31.x.x:3000`
- `file://` 协议（直接打开HTML文件）

### 3. 重启后端服务
要使新的CORS配置生效，需要重启后端服务：

```bash
# 停止当前服务（如果正在运行）
# 在终端中按 Ctrl+C 停止

# 重启服务
cd "F:\Project\政策法规RAG问答系统"
python start_server.py
```

### 4. 验证修复
重启后端服务后，可以通过以下方式验证：

1. **在前端页面点击"测试连接"按钮**
2. **检查浏览器控制台日志**
3. **观察右上角连接状态指示器**

### 5. 调试信息
如果问题仍然存在，请检查浏览器控制台的详细日志：
- 当前页面源地址
- 目标API地址
- 具体的错误类型和建议

## 技术原理

### 动态CORS验证
系统使用正则表达式动态验证请求源：
```python
def is_allowed_origin(origin):
    # 局域网地址匹配 (192.168.x.x:3000)
    if re.match(r'^http://192\.168\.\d+\.\d+:3000$', origin):
        return True
    # 其他局域网段支持...
```

### 开发环境 vs 生产环境
- **开发环境**：使用宽松的动态验证，支持局域网访问
- **生产环境**：使用严格的白名单，只允许指定域名

## 常见问题

### Q: 为什么需要重启后端服务？
A: Flask服务需要重新加载CORS配置才能生效。

### Q: 是否支持其他端口？
A: 当前配置主要支持3000和5000端口，如需其他端口可修改正则表达式。

### Q: 生产环境如何配置？
A: 设置环境变量 `ENVIRONMENT=production` 并指定确切的允许域名。

## 联系支持
如果问题仍然存在，请：
1. 查看浏览器控制台的完整日志
2. 确认后端服务已重启
3. 检查网络防火墙设置