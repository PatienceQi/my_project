#!/usr/bin/env python3
"""
è¿œç¨‹Ollamaé…ç½®ä¿®å¤éªŒè¯æµ‹è¯•è„šæœ¬
éªŒè¯ä¿®å¤åçš„é…ç½®æ˜¯å¦æ­£ç¡®å·¥ä½œï¼Œç¡®ä¿ä¸å†å°è¯•è¿æ¥æœ¬åœ°æœåŠ¡
"""

import os
import sys
import logging
import time
import json
from pathlib import Path
from dotenv import load_dotenv

# è®¾ç½®é¡¹ç›®è·¯å¾„
project_root = Path(__file__).parent.absolute()
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# è®¾ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler('ollama_config_test.log', encoding='utf-8')
    ]
)

class OllamaConfigTest:
    """è¿œç¨‹Ollamaé…ç½®æµ‹è¯•ç±»"""
    
    def __init__(self):
        self.remote_host = 'http://120.232.79.82:11434'
        self.test_results = {}
        self.logger = logging.getLogger(__name__)
        
        # å¼ºåˆ¶è®¾ç½®è¿œç¨‹é…ç½®
        self._force_remote_config()
    
    def _force_remote_config(self):
        """å¼ºåˆ¶è®¾ç½®è¿œç¨‹é…ç½®"""
        config_vars = {
            'LLM_BINDING_HOST': self.remote_host,
            'OLLAMA_HOST': self.remote_host,
            'OLLAMA_BASE_URL': self.remote_host,
            'OLLAMA_NO_SERVE': '1',
            'OLLAMA_ORIGINS': '*',
            'EMBEDDING_MODEL': 'bge-m3:latest',
            'LLM_MODEL': 'llama3.2:latest'
        }
        
        for key, value in config_vars.items():
            os.environ[key] = value
    
    def run_all_tests(self) -> dict:
        """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
        print("ğŸ§ª å¼€å§‹è¿œç¨‹Ollamaé…ç½®ä¿®å¤éªŒè¯æµ‹è¯•")
        print("=" * 60)
        
        test_suite = [
            ("ç¯å¢ƒå˜é‡é…ç½®æµ‹è¯•", self.test_environment_config),
            ("é…ç½®è¯Šæ–­å·¥å…·æµ‹è¯•", self.test_diagnostics_tool),
            ("EntityExtractorä¿®å¤æµ‹è¯•", self.test_entity_extractor),
            ("GraphRAGå¼•æ“ä¿®å¤æµ‹è¯•", self.test_graphrag_engine),
            ("é”™è¯¯å¤„ç†æœºåˆ¶æµ‹è¯•", self.test_error_handling),
            ("æœ¬åœ°è¿æ¥é˜»æ­¢æµ‹è¯•", self.test_local_connection_blocking),
            ("å®Œæ•´å·¥ä½œæµæµ‹è¯•", self.test_complete_workflow)
        ]\n        \n        total_tests = len(test_suite)\n        passed_tests = 0\n        \n        for i, (test_name, test_func) in enumerate(test_suite, 1):\n            print(f\"\\nğŸ”¬ [{i}/{total_tests}] {test_name}\")\n            print(\"-\" * 40)\n            \n            try:\n                result = test_func()\n                self.test_results[test_name] = result\n                \n                if result['success']:\n                    print(f\"   âœ… é€šè¿‡: {result.get('message', '')}\")\n                    passed_tests += 1\n                else:\n                    print(f\"   âŒ å¤±è´¥: {result.get('error', '')}\")\n                    \n            except Exception as e:\n                error_result = {\n                    'success': False,\n                    'error': str(e),\n                    'details': f'æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: {e}'\n                }\n                self.test_results[test_name] = error_result\n                print(f\"   âŒ å¼‚å¸¸: {e}\")\n        \n        # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š\n        self._generate_test_report(passed_tests, total_tests)\n        \n        return {\n            'total_tests': total_tests,\n            'passed_tests': passed_tests,\n            'success_rate': passed_tests / total_tests * 100,\n            'overall_success': passed_tests == total_tests,\n            'results': self.test_results\n        }\n    \n    def test_environment_config(self) -> dict:\n        """æµ‹è¯•ç¯å¢ƒå˜é‡é…ç½®"""\n        try:\n            required_configs = {\n                'LLM_BINDING_HOST': self.remote_host,\n                'OLLAMA_HOST': self.remote_host,\n                'OLLAMA_NO_SERVE': '1'\n            }\n            \n            errors = []\n            for key, expected in required_configs.items():\n                current = os.environ.get(key)\n                if current != expected:\n                    errors.append(f\"{key}: {current} != {expected}\")\n            \n            # æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°åœ°å€é…ç½®\n            local_patterns = ['127.0.0.1', 'localhost', ':64482']\n            for pattern in local_patterns:\n                for env_var in ['LLM_BINDING_HOST', 'OLLAMA_HOST']:\n                    value = os.environ.get(env_var, '')\n                    if pattern in value:\n                        errors.append(f\"æ£€æµ‹åˆ°æœ¬åœ°é…ç½®: {env_var}={value}\")\n            \n            if errors:\n                return {\n                    'success': False,\n                    'error': f\"é…ç½®é”™è¯¯: {'; '.join(errors)}\"\n                }\n            \n            return {\n                'success': True,\n                'message': 'æ‰€æœ‰ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®'\n            }\n            \n        except Exception as e:\n            return {\n                'success': False,\n                'error': f'ç¯å¢ƒé…ç½®æµ‹è¯•å¤±è´¥: {e}'\n            }\n    \n    def test_diagnostics_tool(self) -> dict:\n        \"\"\"æµ‹è¯•é…ç½®è¯Šæ–­å·¥å…·\"\"\"\n        try:\n            from ollama_config_diagnostics import OllamaConfigDiagnostics\n            \n            diagnostics = OllamaConfigDiagnostics()\n            \n            # è¿è¡Œç½‘ç»œè¿æ¥æµ‹è¯•\n            network_result = diagnostics.check_network_connectivity()\n            if not network_result['success']:\n                return {\n                    'success': False,\n                    'error': f\"ç½‘ç»œè¿æ¥å¤±è´¥: {network_result.get('details', '')}\"}\n            \n            # è¿è¡Œç¯å¢ƒå˜é‡æ£€æŸ¥\n            env_result = diagnostics.check_environment_variables()\n            if not env_result['success']:\n                return {\n                    'success': False,\n                    'error': f\"ç¯å¢ƒå˜é‡æ£€æŸ¥å¤±è´¥: {'; '.join(env_result.get('issues', []))}\"}\n            \n            return {\n                'success': True,\n                'message': 'è¯Šæ–­å·¥å…·è¿è¡Œæ­£å¸¸ï¼Œé…ç½®éªŒè¯é€šè¿‡'\n            }\n            \n        except Exception as e:\n            return {\n                'success': False,\n                'error': f'è¯Šæ–­å·¥å…·æµ‹è¯•å¤±è´¥: {e}'\n            }\n    \n    def test_entity_extractor(self) -> dict:\n        \"\"\"æµ‹è¯•EntityExtractorä¿®å¤\"\"\"\n        try:\n            from backend.entity_extractor import EntityExtractor\n            \n            # åˆå§‹åŒ–EntityExtractor\n            extractor = EntityExtractor()\n            \n            # éªŒè¯é…ç½®\n            if '127.0.0.1' in extractor.ollama_host or 'localhost' in extractor.ollama_host:\n                return {\n                    'success': False,\n                    'error': f'EntityExtractorä»åœ¨ä½¿ç”¨æœ¬åœ°åœ°å€: {extractor.ollama_host}'\n                }\n            \n            # éªŒè¯é”™è¯¯å¤„ç†å®¢æˆ·ç«¯\n            if not hasattr(extractor, 'ollama_client'):\n                return {\n                    'success': False,\n                    'error': 'EntityExtractoræœªé›†æˆé”™è¯¯å¤„ç†å®¢æˆ·ç«¯'\n                }\n            \n            # æµ‹è¯•ç®€å•å®ä½“æå–\n            test_text = \"åä¾¨è¯•éªŒåŒºç®¡ç†å§”å‘˜ä¼šè´Ÿè´£å¼€å‘å»ºè®¾å·¥ä½œã€‚\"\n            entities = extractor.extract_entities(test_text)\n            \n            return {\n                'success': True,\n                'message': f'EntityExtractorå·¥ä½œæ­£å¸¸ï¼Œæå–åˆ°{len(entities)}ä¸ªå®ä½“',\n                'details': f'ä½¿ç”¨ä¸»æœº: {extractor.ollama_host}'\n            }\n            \n        except Exception as e:\n            return {\n                'success': False,\n                'error': f'EntityExtractoræµ‹è¯•å¤±è´¥: {e}'\n            }\n    \n    def test_graphrag_engine(self) -> dict:\n        \"\"\"æµ‹è¯•GraphRAGå¼•æ“ä¿®å¤\"\"\"\n        try:\n            from backend.graphrag_engine import GraphRAGEngine\n            \n            # åˆå§‹åŒ–GraphRAGå¼•æ“\n            engine = GraphRAGEngine()\n            \n            # éªŒè¯é…ç½®\n            if '127.0.0.1' in engine.ollama_host or 'localhost' in engine.ollama_host:\n                return {\n                    'success': False,\n                    'error': f'GraphRAGå¼•æ“ä»åœ¨ä½¿ç”¨æœ¬åœ°åœ°å€: {engine.ollama_host}'\n                }\n            \n            # éªŒè¯ç»„ä»¶åˆå§‹åŒ–\n            required_components = ['vector_retriever', 'graph_query_engine', 'entity_extractor']\n            for component in required_components:\n                if not hasattr(engine, component) or getattr(engine, component) is None:\n                    return {\n                        'success': False,\n                        'error': f'GraphRAGå¼•æ“ç»„ä»¶{component}æœªæ­£ç¡®åˆå§‹åŒ–'\n                    }\n            \n            return {\n                'success': True,\n                'message': 'GraphRAGå¼•æ“é…ç½®æ­£ç¡®ï¼Œæ‰€æœ‰ç»„ä»¶åˆå§‹åŒ–æˆåŠŸ',\n                'details': f'ä½¿ç”¨ä¸»æœº: {engine.ollama_host}'\n            }\n            \n        except Exception as e:\n            return {\n                'success': False,\n                'error': f'GraphRAGå¼•æ“æµ‹è¯•å¤±è´¥: {e}'\n            }\n    \n    def test_error_handling(self) -> dict:\n        \"\"\"æµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶\"\"\"\n        try:\n            from backend.ollama_error_handler import (\n                OllamaClientWithFallback, \n                ensure_remote_ollama_config\n            )\n            \n            # æµ‹è¯•é…ç½®ä¿®æ­£å‡½æ•°\n            updated = ensure_remote_ollama_config()\n            \n            # æµ‹è¯•é”™è¯¯å¤„ç†å®¢æˆ·ç«¯\n            client = OllamaClientWithFallback()\n            \n            # éªŒè¯å½“å‰ä¸»æœº\n            if '127.0.0.1' in client.current_host or 'localhost' in client.current_host:\n                return {\n                    'success': False,\n                    'error': f'é”™è¯¯å¤„ç†å®¢æˆ·ç«¯ä½¿ç”¨æœ¬åœ°åœ°å€: {client.current_host}'\n                }\n            \n            # æµ‹è¯•å¥åº·æ£€æŸ¥\n            health = client.health_check()\n            \n            return {\n                'success': True,\n                'message': 'é”™è¯¯å¤„ç†æœºåˆ¶å·¥ä½œæ­£å¸¸',\n                'details': f'å½“å‰ä¸»æœº: {client.current_host}'\n            }\n            \n        except Exception as e:\n            return {\n                'success': False,\n                'error': f'é”™è¯¯å¤„ç†æœºåˆ¶æµ‹è¯•å¤±è´¥: {e}'\n            }\n    \n    def test_local_connection_blocking(self) -> dict:\n        \"\"\"æµ‹è¯•æœ¬åœ°è¿æ¥é˜»æ­¢æœºåˆ¶\"\"\"\n        try:\n            # æš‚æ—¶è®¾ç½®æœ¬åœ°åœ°å€ï¼Œçœ‹æ˜¯å¦ä¼šè¢«è‡ªåŠ¨ä¿®æ­£\n            original_host = os.environ.get('LLM_BINDING_HOST')\n            \n            # å°è¯•è®¾ç½®æœ¬åœ°åœ°å€\n            os.environ['LLM_BINDING_HOST'] = 'http://127.0.0.1:11434'\n            \n            from backend.entity_extractor import EntityExtractor\n            \n            # åˆå§‹åŒ–ï¼Œåº”è¯¥è‡ªåŠ¨ä¿®æ­£ä¸ºè¿œç¨‹åœ°å€\n            extractor = EntityExtractor()\n            \n            # æ¢å¤åŸå§‹é…ç½®\n            if original_host:\n                os.environ['LLM_BINDING_HOST'] = original_host\n            \n            # éªŒè¯æ˜¯å¦è¢«ä¿®æ­£ä¸ºè¿œç¨‹åœ°å€\n            if '127.0.0.1' in extractor.ollama_host or 'localhost' in extractor.ollama_host:\n                return {\n                    'success': False,\n                    'error': f'æœ¬åœ°è¿æ¥é˜»æ­¢å¤±è´¥ï¼Œä»ä½¿ç”¨: {extractor.ollama_host}'\n                }\n            \n            return {\n                'success': True,\n                'message': 'æœ¬åœ°è¿æ¥é˜»æ­¢æœºåˆ¶æœ‰æ•ˆ',\n                'details': f'è‡ªåŠ¨ä¿®æ­£ä¸º: {extractor.ollama_host}'\n            }\n            \n        except Exception as e:\n            return {\n                'success': False,\n                'error': f'æœ¬åœ°è¿æ¥é˜»æ­¢æµ‹è¯•å¤±è´¥: {e}'\n            }\n    \n    def test_complete_workflow(self) -> dict:\n        \"\"\"æµ‹è¯•å®Œæ•´å·¥ä½œæµç¨‹\"\"\"\n        try:\n            # é¦–å…ˆè¿è¡Œé…ç½®è¯Šæ–­\n            from ollama_config_diagnostics import OllamaConfigDiagnostics\n            diagnostics = OllamaConfigDiagnostics()\n            \n            # éªŒè¯è¿œç¨‹è¿æ¥\n            network_result = diagnostics.check_network_connectivity()\n            if not network_result['success']:\n                return {\n                    'success': False,\n                    'error': f'è¿œç¨‹è¿æ¥å¤±è´¥: {network_result.get(\"details\", \"\")}'\n                }\n            \n            # æµ‹è¯•å®ä½“æå–å·¥ä½œæµ\n            from backend.entity_extractor import EntityExtractor\n            extractor = EntityExtractor()\n            \n            test_text = \"åä¾¨ç»æµæ–‡åŒ–åˆä½œè¯•éªŒåŒºç®¡ç†å§”å‘˜ä¼šè´Ÿè´£è¯•éªŒåŒºçš„å¼€å‘å»ºè®¾ã€‚\"\n            \n            # æå–å®ä½“\n            entities = extractor.extract_entities(test_text)\n            \n            # å¦‚æœæœ‰å®ä½“ï¼Œæµ‹è¯•å…³ç³»æå–\n            if entities:\n                relations = extractor.extract_relations(test_text, entities)\n                \n                return {\n                    'success': True,\n                    'message': f'å®Œæ•´å·¥ä½œæµæµ‹è¯•æˆåŠŸ',\n                    'details': f'æå–{len(entities)}ä¸ªå®ä½“ï¼Œ{len(relations)}ä¸ªå…³ç³»'\n                }\n            else:\n                return {\n                    'success': True,\n                    'message': 'å®Œæ•´å·¥ä½œæµæµ‹è¯•æˆåŠŸï¼ˆæœªæå–åˆ°å®ä½“ï¼Œä½†æµç¨‹æ­£å¸¸ï¼‰'\n                }\n            \n        except Exception as e:\n            return {\n                'success': False,\n                'error': f'å®Œæ•´å·¥ä½œæµæµ‹è¯•å¤±è´¥: {e}'\n            }\n    \n    def _generate_test_report(self, passed: int, total: int):\n        \"\"\"ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š\"\"\"\n        print(\"\\n\" + \"=\" * 60)\n        print(\"ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“\")\n        print(\"=\" * 60)\n        \n        success_rate = passed / total * 100\n        status = \"âœ… æˆåŠŸ\" if passed == total else \"âš ï¸ éƒ¨åˆ†å¤±è´¥\" if passed > 0 else \"âŒ å¤±è´¥\"\n        \n        print(f\"æ€»ä½“çŠ¶æ€: {status}\")\n        print(f\"é€šè¿‡æµ‹è¯•: {passed}/{total} ({success_rate:.1f}%)\")\n        \n        # è¯¦ç»†ç»“æœ\n        print(\"\\nè¯¦ç»†ç»“æœ:\")\n        for test_name, result in self.test_results.items():\n            status_icon = \"âœ…\" if result['success'] else \"âŒ\"\n            print(f\"  {status_icon} {test_name}\")\n            if not result['success']:\n                print(f\"     é”™è¯¯: {result.get('error', 'Unknown')}\")\n        \n        # å»ºè®®\n        if passed < total:\n            print(\"\\nğŸ”§ ä¿®å¤å»ºè®®:\")\n            failed_tests = [name for name, result in self.test_results.items() if not result['success']]\n            for test in failed_tests:\n                print(f\"  - æ£€æŸ¥{test}çš„é”™è¯¯ä¿¡æ¯å¹¶ä¿®å¤ç›¸å…³é…ç½®\")\n        else:\n            print(\"\\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼è¿œç¨‹Ollamaé…ç½®ä¿®å¤æˆåŠŸã€‚\")\n        \n        # ä¿å­˜æµ‹è¯•æŠ¥å‘Šåˆ°æ–‡ä»¶\n        report_file = 'ollama_config_test_report.json'\n        with open(report_file, 'w', encoding='utf-8') as f:\n            json.dump({\n                'timestamp': time.strftime('%Y-%m-%d %H:%M:%S'),\n                'summary': {\n                    'total_tests': total,\n                    'passed_tests': passed,\n                    'success_rate': success_rate,\n                    'overall_success': passed == total\n                },\n                'results': self.test_results\n            }, f, ensure_ascii=False, indent=2)\n        \n        print(f\"\\nğŸ“„ è¯¦ç»†æµ‹è¯•æŠ¥å‘Šå·²ä¿å­˜åˆ°: {report_file}\")\n\n\ndef main():\n    \"\"\"ä¸»å‡½æ•°\"\"\"\n    test_runner = OllamaConfigTest()\n    results = test_runner.run_all_tests()\n    \n    return results['overall_success']\n\n\nif __name__ == \"__main__\":\n    success = main()\n    sys.exit(0 if success else 1)