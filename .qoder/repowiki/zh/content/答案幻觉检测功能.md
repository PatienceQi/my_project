# 答案幻觉检测功能

<cite>
**本文档引用文件**   
- [hallucination_detector.py](file://backend/hallucination_detector.py#L0-L434)
- [graph_query.py](file://backend/graph_query.py#L0-L462)
- [entity_extractor.py](file://backend/entity_extractor.py#L0-L491)
- [graphrag_engine.py](file://backend/graphrag_engine.py#L0-L485)
</cite>

## 目录
1. [功能概述](#功能概述)
2. [多维度验证方法](#多维度验证方法)
3. [可信度评分算法](#可信度评分算法)
4. [风险等级判定机制](#风险等级判定机制)
5. [警告信息生成](#警告信息生成)
6. [可信度解释生成](#可信度解释生成)
7. [系统集成流程](#系统集成流程)
8. [配置参数](#配置参数)

## 功能概述
答案幻觉检测功能是政策法规RAG问答系统中的核心安全机制，旨在通过多维度验证防止生成包含虚假或未经证实信息的答案。该功能基于知识图谱和检索文档，对生成的答案进行系统性评估，确保其准确性和可靠性。

该功能作为GraphRAG引擎的一部分，在答案生成后自动执行检测流程。检测器通过分析答案与知识图谱、检索文档的一致性，计算综合可信度分数，并据此判断答案的风险等级。这一机制有效降低了大语言模型在专业领域问答中产生"幻觉"（即编造信息）的风险。

**Section sources**
- [hallucination_detector.py](file://backend/hallucination_detector.py#L0-L20)

## 多维度验证方法
答案幻觉检测采用四维验证框架，从不同角度评估答案的可信度。每个维度独立评分，最终通过加权求和得到综合可信度。

### 实体一致性检查
该维度验证答案中提及的实体是否存在于知识图谱中。检测器首先使用实体提取器从答案中提取关键实体，然后与图谱上下文中的已知实体进行匹配。

匹配过程包括完全匹配和部分匹配两种策略：
- **完全匹配**：答案实体与图谱实体名称完全一致，得分为1
- **部分匹配**：答案实体为图谱实体的子串或反之，且长度大于2个字符，得分为0.5

``mermaid
flowchart TD
A[开始] --> B[从答案中提取实体]
B --> C{是否提取到实体?}
C --> |否| D[返回0.5分]
C --> |是| E[获取图谱中的已知实体]
E --> F[计算匹配度]
F --> G[返回一致性分数]
```

**Diagram sources**
- [hallucination_detector.py](file://backend/hallucination_detector.py#L110-L171)

### 关系验证检查
该维度验证答案中描述的实体间关系是否在知识图谱中存在。检测器通过正则表达式模式匹配从答案中提取主谓宾关系，然后调用图谱查询引擎验证这些关系。

支持的关系类型包括：
- 负责(RESPONSIBLE_FOR)
- 管理(MANAGES)
- 审批(APPROVES)
- 发布(PUBLISHES)
- 适用于(APPLIES_TO)
- 要求(REQUIRES)

``mermaid
sequenceDiagram
participant Answer as 答案文本
participant Extractor as 关系提取器
participant Graph as 知识图谱
participant Detector as 幻觉检测器
Answer->>Extractor : 提取主谓宾关系
Extractor->>Graph : 查询关系存在性
Graph-->>Extractor : 返回验证结果
Extractor->>Detector : 返回验证分数
```

**Diagram sources**
- [hallucination_detector.py](file://backend/hallucination_detector.py#L172-L234)
- [graph_query.py](file://backend/graph_query.py#L350-L398)

### 内容重叠度检查
该维度评估答案内容与检索到的相关文档的相似程度。检测器首先提取答案的关键词，然后计算这些关键词与各检索文档关键词的重叠率。

关键词提取使用jieba分词库，并过滤停用词和标点符号。重叠度分数为所有检索文档重叠率的平均值。

``mermaid
flowchart TD
A[开始] --> B[提取答案关键词]
B --> C{是否有关键词?}
C --> |否| D[返回0.3分]
C --> |是| E[遍历检索文档]
E --> F[提取文档关键词]
F --> G[计算重叠率]
G --> H{处理完所有文档?}
H --> |否| E
H --> |是| I[计算平均重叠度]
I --> J[返回内容分数]
```

**Diagram sources**
- [hallucination_detector.py](file://backend/hallucination_detector.py#L199-L233)

### 语义连贯性检查
该维度评估答案的逻辑完整性和问题相关性。检测器通过关键词重叠和启发式规则两个方面进行评估。

评估指标包括：
- **问题相关性**：答案与问题的关键词重叠度
- **逻辑连接词**：答案中是否包含"因为"、"所以"、"由于"等逻辑连接词
- **具体信息**：答案中是否包含"规定"、"要求"、"政策"等具体信息关键词

``mermaid
flowchart TD
A[开始] --> B[检查答案长度]
B --> C{长度<10?}
C --> |是| D[返回0.2分]
C --> |否| E[提取问题和答案关键词]
E --> F{关键词存在?}
F --> |否| G[返回0.4分]
F --> |是| H[计算关键词重叠]
H --> I[检查逻辑连接词]
I --> J[检查具体信息]
J --> K[综合评分]
K --> L[返回连贯性分数]
```

**Diagram sources**
- [hallucination_detector.py](file://backend/hallucination_detector.py#L235-L266)

## 可信度评分算法
综合可信度通过加权求和四个维度的分数计算得出。各维度的权重配置如下：

**权重配置**
- 实体一致性权重: 0.4
- 关系验证权重: 0.3
- 内容重叠权重: 0.2
- 语义连贯性权重: 0.1

计算公式为：
```
综合可信度 = (实体一致性分数 × 0.4) + 
            (关系验证分数 × 0.3) + 
            (内容重叠分数 × 0.2) + 
            (语义连贯性分数 × 0.1)
```

``mermaid
classDiagram
class HallucinationDetector {
+float hallucination_threshold
+dict weights
+detect_hallucination(answer, question, retrieved_docs, graph_context) Dict
-_check_entity_consistency(answer, graph_context) float
-_verify_relations(answer, graph_context) float
-_check_content_overlap(answer, retrieved_docs) float
-_check_semantic_coherence(answer, question) float
-_determine_risk_level(confidence) str
-_generate_warnings(entity_score, relation_score, content_score, coherence_score) List[str]
-generate_confidence_explanation(detection_result) str
}
class GraphQueryEngine {
+verify_entity_relations(entities, relations) List[Dict]
}
class EntityExtractor {
+extract_entities_from_question(question) List[str]
}
HallucinationDetector --> GraphQueryEngine : "使用"
HallucinationDetector --> EntityExtractor : "使用"
```

**Diagram sources**
- [hallucination_detector.py](file://backend/hallucination_detector.py#L48-L82)

## 风险等级判定机制
根据综合可信度分数，系统将答案划分为三个风险等级：

**风险等级判定规则**
- 低风险: 可信度 ≥ 0.8
- 中风险: 0.5 ≤ 可信度 < 0.8
- 高风险: 可信度 < 0.5

``mermaid
flowchart LR
A[综合可信度] --> B{≥0.8?}
B --> |是| C[低风险]
B --> |否| D{≥0.5?}
D --> |是| E[中风险]
D --> |否| F[高风险]
```

**Diagram sources**
- [hallucination_detector.py](file://backend/hallucination_detector.py#L362-L367)

## 警告信息生成
系统根据各维度的得分生成相应的警告信息，帮助用户理解答案的潜在问题。

**警告生成规则**
- 实体一致性 < 0.5: "答案中包含未经验证的实体信息"
- 关系验证 < 0.4: "答案中的关系描述可能不准确"
- 内容重叠 < 0.3: "答案内容与检索文档相关性较低"
- 语义连贯性 < 0.4: "答案的逻辑连贯性有待改善"

当所有维度分数均低于0.5时，系统会生成综合警告："⚠️ 答案可信度较低，建议谨慎对待"。

``mermaid
flowchart TD
A[各维度分数] --> B{实体一致性<0.5?}
B --> |是| C[添加实体警告]
B --> |否| D{关系验证<0.4?}
D --> |是| E[添加关系警告]
D --> |否| F{内容重叠<0.3?}
F --> |是| G[添加内容警告]
F --> |否| H{语义连贯性<0.4?}
H --> |是| I[添加连贯性警告]
H --> |否| J{所有分数<0.5?}
J --> |是| K[添加综合警告]
J --> |否| L[完成]
```

**Diagram sources**
- [hallucination_detector.py](file://backend/hallucination_detector.py#L368-L388)

## 可信度解释生成
系统提供自然语言形式的可信度解释，帮助用户理解检测结果。

**解释生成规则**
- 可信度 ≥ 0.8: "答案具有较高可信度"
- 0.5 ≤ 可信度 < 0.8: "答案具有中等可信度"
- 可信度 < 0.5: "答案可信度较低"

此外，系统还会根据各维度的具体得分添加详细分析：
- 实体一致性 ≥ 0.7: "实体信息已验证"
- 关系验证 ≥ 0.6: "关系描述基本准确"
- 内容重叠 ≥ 0.6: "内容与文档资料吻合"

``mermaid
sequenceDiagram
participant Detector as 幻觉检测器
participant Result as 检测结果
participant Explanation as 可信度解释
Detector->>Result : 执行检测
Result->>Explanation : 调用generate_confidence_explanation
Explanation->>Explanation : 分析总体评价
Explanation->>Explanation : 分析详细维度
Explanation-->>Detector : 返回解释文本
```

**Diagram sources**
- [hallucination_detector.py](file://backend/hallucination_detector.py#L389-L401)

## 系统集成流程
答案幻觉检测功能深度集成于GraphRAG问答流程中，作为答案生成后的关键验证环节。

``mermaid
sequenceDiagram
participant User as 用户
participant API as API服务器
participant Engine as GraphRAG引擎
participant Detector as 幻觉检测器
participant LLM as 大语言模型
User->>API : 提交问题
API->>Engine : 调用answer_question
Engine->>Engine : 提取问题实体
Engine->>Engine : 执行向量检索
Engine->>Engine : 执行图谱查询
Engine->>Engine : 构建增强上下文
Engine->>LLM : 生成答案
Engine->>Detector : 执行幻觉检测
Detector->>Detector : 多维度验证
Detector-->>Engine : 返回检测结果
Engine-->>API : 返回完整响应
API-->>User : 显示答案和可信度
```

**Diagram sources**
- [graphrag_engine.py](file://backend/graphrag_engine.py#L156-L188)

## 配置参数
系统通过环境变量和代码常量配置幻觉检测行为。

**环境变量配置**
- HALLUCINATION_THRESHOLD: 幻觉检测阈值，默认值0.7
- LLM_MODEL: 使用的大语言模型名称，默认值"llama3.2:latest"
- CONFIDENCE_THRESHOLD: 实体提取置信度阈值，默认值0.4
- GRAPH_RETRIEVAL_TOP_K: 图谱检索返回结果数，默认值5

**代码常量配置**
- 实体一致性权重: 0.4
- 关系验证权重: 0.3
- 内容重叠权重: 0.2
- 语义连贯性权重: 0.1

**Section sources**
- [hallucination_detector.py](file://backend/hallucination_detector.py#L25-L35)
- [graphrag_engine.py](file://backend/graphrag_engine.py#L15-L20)