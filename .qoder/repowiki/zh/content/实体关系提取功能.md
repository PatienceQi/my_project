# 实体关系提取功能

<cite>
**本文档引用的文件**   
- [entity_extractor.py](file://backend/entity_extractor.py)
- [ollama_error_handler.py](file://backend/ollama_error_handler.py)
- [import_graphrag_data.py](file://scripts/import_graphrag_data.py)
- [graph_query.py](file://backend/graph_query.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细介绍了“政策法规RAG问答系统”中的**实体关系提取功能**。该功能是整个系统的核心组成部分，负责从政策法规文本中智能识别关键实体（如机构、政策、地点等）及其相互关系，并将这些结构化信息持久化到知识图谱中，为后续的智能问答、信息检索和语义推理提供数据基础。

本功能主要依赖Ollama大语言模型进行自然语言理解，通过精心设计的提示工程（Prompt Engineering）引导模型输出结构化的实体和关系数据。系统集成了置信度评分机制、错误处理与连接管理、以及与知识图谱的深度集成，确保了数据提取的准确性、可靠性和可追溯性。

## 项目结构
项目采用分层架构，将前端、后端、数据和脚本清晰分离。实体关系提取功能主要分布在`backend`和`scripts`目录下。

``mermaid
graph TB
subgraph "前端"
index_html["index.html"]
index_graphrag_html["index_graphrag.html"]
end
subgraph "后端"
api_server["api_server.py"]
entity_extractor["entity_extractor.py"]
graph_query["graph_query.py"]
ollama_error_handler["ollama_error_handler.py"]
end
subgraph "数据"
database["database/"]
data["data/"]
end
subgraph "脚本"
import_graphrag_data["import_graphrag_data.py"]
start_server["start_server.py"]
end
index_html --> api_server
index_graphrag_html --> api_server
api_server --> entity_extractor
entity_extractor --> ollama_error_handler
import_graphrag_data --> entity_extractor
import_graphrag_data --> graph_query
import_graphrag_data --> entity_extractor
```

**Diagram sources**
- [entity_extractor.py](file://backend/entity_extractor.py)
- [import_graphrag_data.py](file://scripts/import_graphrag_data.py)

**Section sources**
- [entity_extractor.py](file://backend/entity_extractor.py)
- [import_graphrag_data.py](file://scripts/import_graphrag_data.py)

## 核心组件
本功能的核心在于`EntityExtractor`类，它封装了与Ollama交互、实体关系提取、置信度过滤和错误处理的全部逻辑。该组件与`OllamaClientWithFallback`协同工作，确保在主服务不可用时仍能保持系统稳定。最终，提取出的实体和关系通过`GraphRAGDataImporter`被持久化到Neo4j知识图谱中。

**Section sources**
- [entity_extractor.py](file://backend/entity_extractor.py#L23-L447)
- [ollama_error_handler.py](file://backend/ollama_error_handler.py#L175-L239)
- [import_graphrag_data.py](file://scripts/import_graphrag_data.py#L253-L288)

## 架构概述
整个实体关系提取流程是一个典型的ETL（提取、转换、加载）过程，涉及多个组件的协同工作。

``mermaid
sequenceDiagram
participant Script as import_graphrag_data.py
participant Extractor as EntityExtractor
participant Ollama as Ollama API
participant GraphDB as Neo4j 图数据库
Script->>Extractor : load_policy_documents()
Script->>Extractor : extract_all_from_document()
Extractor->>Extractor : extract_entities(text)
Extractor->>Ollama : _call_ollama(prompt)
Ollama-->>Extractor : JSON响应
Extractor->>Extractor : _parse_entity_response()
Extractor->>Extractor : 过滤置信度
Extractor-->>Script : 返回实体列表
Script->>Extractor : extract_relations(text, entities)
Extractor->>Ollama : _call_ollama(prompt)
Ollama-->>Extractor : JSON响应
Extractor->>Extractor : _parse_relation_response()
Extractor->>Extractor : 验证实体存在性
Extractor-->>Script : 返回关系列表
Script->>GraphDB : _create_policy_node()
Script->>GraphDB : _create_entity_nodes()
Script->>GraphDB : _create_relation_edges()
```

**Diagram sources**
- [entity_extractor.py](file://backend/entity_extractor.py)
- [import_graphrag_data.py](file://scripts/import_graphrag_data.py)

## 详细组件分析

### 实体提取器分析
`EntityExtractor`是整个功能的核心，负责与Ollama大模型交互，完成实体和关系的提取。

#### 类结构与依赖关系
``mermaid
classDiagram
class EntityExtractor {
+string ollama_host
+string model_name
+float confidence_threshold
+OllamaClientWithFallback ollama_client
+extract_entities(text) List[Dict]
+extract_relations(text, entities) List[Dict]
+extract_entities_from_question(question) List[str]
+_build_entity_extraction_prompt(text) string
+_build_relation_extraction_prompt(text, entities) string
+_call_ollama(prompt) string
+_parse_entity_response(response) List[Dict]
}
class OllamaClientWithFallback {
+OllamaErrorHandler error_handler
+string current_host
+generate_text(model, prompt, options) string
+call_api(endpoint, payload) Dict
}
class OllamaErrorHandler {
+string primary_host
+int max_retries
+execute_with_fallback(func) Any
+_execute_with_retry(func) tuple
}
EntityExtractor --> OllamaClientWithFallback : "使用"
OllamaClientWithFallback --> OllamaErrorHandler : "包含"
```

**Diagram sources**
- [entity_extractor.py](file://backend/entity_extractor.py#L23-L447)
- [ollama_error_handler.py](file://backend/ollama_error_handler.py#L175-L239)

#### 实体提取流程
实体提取流程始于`extract_entities`方法，它构建一个详细的提示（Prompt），引导Ollama模型从文本中识别出特定类型的实体。

``mermaid
flowchart TD
Start([开始提取实体]) --> BuildPrompt["构建实体提取提示"]
BuildPrompt --> CallOllama["调用Ollama API"]
CallOllama --> ParseResponse["解析JSON响应"]
ParseResponse --> ValidateEntities["验证实体字段"]
ValidateEntities --> FilterConfidence["根据置信度阈值过滤"]
FilterConfidence --> ReturnEntities["返回高置信度实体列表"]
CallOllama --> |失败| HandleError["记录错误并返回空列表"]
HandleError --> ReturnEntities
```

**Section sources**
- [entity_extractor.py](file://backend/entity_extractor.py#L100-L118)

#### 关系提取流程
关系提取依赖于已提取的实体列表，通过`extract_relations`方法实现。

``mermaid
flowchart TD
Start([开始提取关系]) --> CheckEntities["检查实体数量 >= 2"]
CheckEntities --> |否| ReturnEmpty["返回空列表"]
CheckEntities --> |是| BuildPrompt["构建关系提取提示"]
BuildPrompt --> CallOllama["调用Ollama API"]
CallOllama --> ParseResponse["解析JSON响应"]
ParseResponse --> ValidateRelations["验证关系源/目标实体存在"]
ValidateRelations --> ReturnRelations["返回有效关系列表"]
CallOllama --> |失败| HandleError["记录错误并返回空列表"]
HandleError --> ReturnRelations
```

**Section sources**
- [entity_extractor.py](file://backend/entity_extractor.py#L125-L152)

### 提示工程分析
提示工程是确保大模型输出格式化、高质量数据的关键。`EntityExtractor`通过两个专用方法构建提示。

#### 实体提取提示
该提示明确指定了实体类型、输出格式和置信度要求，确保模型输出结构化的JSON。

```python
def _build_entity_extraction_prompt(self, text: str) -> str:
    prompt = f"""
    你是一个专业的政策文档分析专家。请从以下政策文本中提取关键实体，按照指定格式返回JSON：

    文本：{text[:1000]}...

    请提取以下类型的实体：
    - 组织机构(ORG)：政府部门、企业、事业单位、社会团体等
    - 政策概念(CONCEPT)：政策术语、专业概念、业务术语等  
    - 地理位置(LOCATION)：国家、省市、区域、具体地点等
    - 时间信息(TIME)：日期、期限、时间段等
    - 人员角色(PERSON)：职位、岗位、人员类别等
    - 法规条款(REGULATION)：法律条文、政策条款、规定等

    输出要求：
    1. 只返回JSON格式，不要其他解释
    2. 每个实体包含text（实体文本）、label（类型）、confidence（置信度0-1）
    3. 置信度基于实体在文本中的重要性和明确性

    输出格式：
    {{
        "entities": [
            {{"text": "实体名称", "label": "ORG", "confidence": 0.9}},
            {{"text": "另一个实体", "label": "CONCEPT", "confidence": 0.8}}
        ]
    }}
    """
    return prompt
```

**Section sources**
- [entity_extractor.py](file://backend/entity_extractor.py#L198-L211)

#### 关系提取提示
该提示将已识别的实体列表作为上下文，引导模型分析它们之间的关系。

```python
def _build_relation_extraction_prompt(self, text: str, entities: List[Dict]) -> str:
    entity_list = [entity['text'] for entity in entities]
    prompt = f"""
    你是一个专业的政策文档分析专家。请分析以下文本中实体间的关系：

    文本：{text[:1000]}...

    已识别实体：{', '.join(entity_list)}

    请识别以下类型的关系：
    - 发布(PUBLISHES)：机构发布政策
    - 适用于(APPLIES_TO)：政策适用于某对象
    - 管理(MANAGES)：机构管理某事务
    - 要求(REQUIRES)：政策要求某行为
    - 包含(CONTAINS)：文档包含某内容
    - 负责(RESPONSIBLE_FOR)：机构负责某事务
    - 审批(APPROVES)：机构审批某事项
    - 监督(SUPERVISES)：机构监督某活动

    输出要求：
    1. 只返回JSON格式
    2. 只提取确实存在的关系
    3. source和target必须是已识别的实体

    输出格式：
    {{
        "relations": [
            {{"source": "实体1", "target": "实体2", "relation": "PUBLISHES", "confidence": 0.9}},
            {{"source": "实体2", "target": "实体3", "relation": "APPLIES_TO", "confidence": 0.8}}
        ]
    }}
    """
    return prompt
```

**Section sources**
- [entity_extractor.py](file://backend/entity_extractor.py#L213-L248)

### 置信度评分与过滤
系统通过置信度评分来衡量模型对提取结果的确定性，并通过阈值过滤来保证数据质量。

- **置信度来源**：由Ollama模型在生成响应时提供，反映了模型对实体或关系存在的信心。
- **配置**：阈值通过环境变量`CONFIDENCE_THRESHOLD`配置，默认值为`0.4`。
- **过滤**：在`extract_entities`和`extract_relations`方法中，使用列表推导式过滤掉低于阈值的结果。

```python
# 在 extract_entities 方法中
filtered_entities = [
    entity for entity in entities 
    if entity.get('confidence', 0) >= self.confidence_threshold
]
```

**Section sources**
- [entity_extractor.py](file://backend/entity_extractor.py#L34)
- [entity_extractor.py](file://backend/entity_extractor.py#L115)

### 错误处理与连接管理
为了确保系统的健壮性，系统实现了复杂的错误处理和连接管理策略。

#### Ollama客户端回退机制
`OllamaClientWithFallback`类通过`OllamaErrorHandler`实现了重试和主机切换机制。

``mermaid
flowchart TD
Start([调用generate_text]) --> GetHost["获取当前主机地址"]
GetHost --> CheckLocal["检查是否为localhost/127.0.0.1"]
CheckLocal --> |是| ForceRemote["强制切换到远程主机"]
CheckLocal --> |否| MakeRequest["发起API请求"]
ForceRemote --> MakeRequest
MakeRequest --> |成功| ReturnResponse["返回响应"]
MakeRequest --> |失败| Retry["执行重试逻辑"]
Retry --> |重试成功| ReturnResponse
Retry --> |重试耗尽| ThrowError["抛出连接错误"]
```

**Section sources**
- [ollama_error_handler.py](file://backend/ollama_error_handler.py#L175-L239)

#### 连接验证
`EntityExtractor`在初始化时会强制设置远程Ollama配置，并验证连接和模型可用性。

```python
def _force_remote_ollama_config(self):
    """强制设置远程Ollama配置"""
    remote_host = 'http://120.232.79.82:11434'
    config_vars = {
        'OLLAMA_HOST': remote_host,
        'OLLAMA_BASE_URL': remote_host,
        'LLM_BINDING_HOST': remote_host,
        # ... 其他环境变量
    }
    # 更新环境变量
    for key, value in config_vars.items():
        os.environ[key] = value
```

**Section sources**
- [entity_extractor.py](file://backend/entity_extractor.py#L50-L68)

### 与知识图谱的集成
提取出的实体和关系最终被持久化到Neo4j知识图谱中，由`import_graphrag_data.py`脚本负责。

#### 数据持久化流程
``mermaid
sequenceDiagram
participant Importer as GraphRAGDataImporter
participant Extractor as EntityExtractor
participant GraphDB as Neo4j
Importer->>Extractor : _extract_entities_and_relations()
Extractor-->>Importer : 返回提取结果
Importer->>GraphDB : _create_policy_node()
Importer->>GraphDB : _create_entity_nodes()
Importer->>GraphDB : _create_relation_edges()
```

**Diagram sources**
- [import_graphrag_data.py](file://scripts/import_graphrag_data.py#L253-L288)

#### Neo4j节点与关系创建
使用Cypher查询语言在Neo4j中创建节点和关系。

```python
# 创建实体节点
query = """
MERGE (e:Entity {name: $name, type: $type})
SET e.text = $text,
    e.confidence = $confidence
WITH e
MATCH (p:Policy {id: $doc_id})
MERGE (e)-[:MENTIONED_IN]->(p)
"""

# 创建关系边
query = """
MATCH (e1:Entity {name: $source})
MATCH (e2:Entity {name: $target})
MATCH (p:Policy {id: $doc_id})
MERGE (e1)-[r:RELATES_TO {type: $relation_type}]->(e2)
SET r.confidence = $confidence,
    r.document_id = $doc_id
"""
```

**Section sources**
- [import_graphrag_data.py](file://scripts/import_graphrag_data.py#L408-L444)

#### 实体关系验证
`GraphQueryEngine`提供了`verify_entity_relations`方法，用于验证知识图谱中实体间关系的存在性。

```python
def verify_entity_relations(self, entities: List[str], relations: List[str]) -> List[Dict]:
    """验证实体间的关系是否存在于图谱中"""
    query = """
    MATCH (e1:Entity)-[r]-(e2:Entity)
    WHERE 
        (e1.name CONTAINS $entity1 OR e1.text CONTAINS $entity1) AND
        (e2.name CONTAINS $entity2 OR e2.text CONTAINS $entity2)
    RETURN 
        e1.name as entity1_name,
        e2.name as entity2_name,
        type(r) as relation_type,
        properties(r) as relation_properties
    LIMIT 5
    """
    # 执行查询并返回结果
```

**Section sources**
- [graph_query.py](file://backend/graph_query.py#L341-L391)

## 依赖分析
系统各组件之间存在明确的依赖关系，形成了一个从数据导入到知识图谱构建的完整链条。

``mermaid
graph TD
import_graphrag_data --> entity_extractor
import_graphrag_data --> graph_query
entity_extractor --> ollama_error_handler
entity_extractor --> Ollama[Ollama API]
graph_query --> Neo4j[Neo4j 图数据库]
api_server --> entity_extractor
```

**Diagram sources**
- [import_graphrag_data.py](file://scripts/import_graphrag_data.py)
- [entity_extractor.py](file://backend/entity_extractor.py)

## 性能考虑
- **批处理**：`import_graphrag_data.py`采用分批处理文档（`batch_size = 10`），避免内存溢出。
- **连接管理**：`OllamaErrorHandler`实现了重试机制（`max_retries = 3`）和递增延迟，避免因瞬时故障导致任务失败。
- **查询优化**：Neo4j查询中使用了`LIMIT`和`UNWIND`等操作符，以提高查询效率。

## 故障排除指南
- **连接Ollama失败**：检查日志中是否出现`localhost`或`127.0.0.1`，这表明配置被意外修改。确保环境变量`LLM_BINDING_HOST`指向正确的远程地址。
- **模型不可用**：检查`_validate_remote_connection`日志，确认目标模型（如`llama3.2:latest`）在Ollama服务中已加载。
- **知识图谱为空**：检查`import_graphrag_data.py`脚本是否成功执行，确认`rebuild_graph`参数设置正确，并检查Neo4j服务是否正常运行。
- **提取结果为空**：检查输入文本是否过长，提示工程中的`text[:1000]`可能截断了关键信息。

## 结论
实体关系提取功能是“政策法规RAG问答系统”的数据基石。它通过结合大语言模型的强大语义理解能力与精心设计的提示工程，实现了从非结构化文本到结构化知识的自动化转换。系统通过置信度过滤、严格的错误处理和与知识图谱的深度集成，确保了提取结果的高质量和高可靠性。该功能的设计体现了现代AI应用中“提示即代码”的理念，是构建智能问答系统的关键一环。