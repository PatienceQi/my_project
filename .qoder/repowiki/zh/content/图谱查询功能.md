# 图谱查询功能

<cite>
**本文档引用的文件**
- [graph_query.py](file://backend/graph_query.py)
- [graphrag_engine.py](file://backend/graphrag_engine.py)
- [connections.py](file://backend/connections.py)
- [test_graphrag_system.py](file://scripts/test_graphrag_system.py)
- [test_neo4j_connection.py](file://scripts/test_neo4j_connection.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细介绍了政策法规RAG问答系统中的图谱查询功能。该功能基于Neo4j图数据库，为系统提供实体查询、关系查询和政策检索等核心能力。图谱查询功能与GraphRAG引擎深度集成，通过结合向量检索和知识图谱技术，显著提升了问答系统的准确性和可靠性。文档涵盖了连接机制、查询方法、集成模式以及性能优化等关键方面。

## 项目结构
项目采用分层架构，主要分为后端、数据、数据库、前端和脚本五个目录。图谱查询功能的核心代码位于`backend`目录下的`graph_query.py`文件中，该文件实现了与Neo4j的连接和各种查询操作。`graphrag_engine.py`文件则负责将图谱查询结果与向量检索结果融合，生成最终的增强上下文。`connections.py`文件提供了统一的连接管理，确保系统各组件能够稳定访问Neo4j和Ollama服务。

``mermaid
graph TB
subgraph "后端模块"
GQE[graph_query.py]
GRE[graphrag_engine.py]
CON[connections.py]
API[api_server.py]
end
subgraph "数据与数据库"
DATA[data]
DB[database]
end
subgraph "脚本"
SCRIPTS[scripts]
end
GQE --> |查询| DB
GRE --> |调用| GQE
GRE --> |调用| CON
API --> |调用| GRE
SCRIPTS --> |测试| GQE
SCRIPTS --> |测试| GRE
```

**图表来源**
- [graph_query.py](file://backend/graph_query.py#L1-L436)
- [graphrag_engine.py](file://backend/graphrag_engine.py#L1-L484)
- [connections.py](file://backend/connections.py#L1-L545)

**章节来源**
- [graph_query.py](file://backend/graph_query.py#L1-L436)
- [graphrag_engine.py](file://backend/graphrag_engine.py#L1-L484)

## 核心组件
图谱查询功能的核心是`GraphQueryEngine`类，它封装了所有与Neo4j交互的逻辑。该类通过环境变量读取连接配置，初始化Neo4j驱动，并提供了一系列查询方法，包括实体查询、政策查询、关系网络查询等。`GraphQueryEngine`与`GraphRAGEngine`紧密协作，前者负责从图数据库中提取结构化信息，后者则将这些信息与向量检索结果结合，生成用于大语言模型的上下文。

**章节来源**
- [graph_query.py](file://backend/graph_query.py#L14-L391)
- [graphrag_engine.py](file://backend/graphrag_engine.py#L1-L484)

## 架构概述
系统的整体架构围绕GraphRAG引擎构建，该引擎整合了向量检索、图谱查询、实体提取和幻觉检测等多个模块。当用户提出问题时，系统首先提取问题中的关键实体，然后并行执行向量检索和图谱查询。图谱查询部分会根据提取的实体，从Neo4j中获取相关的实体、政策和关系网络。最后，GraphRAG引擎将所有信息融合，生成一个增强的上下文，供大语言模型生成最终答案。

``mermaid
graph TD
User[用户问题] --> API[API服务器]
API --> GREE[GraphRAG引擎]
GREE --> EE[实体提取器]
EE --> GREE
GREE --> VR[向量检索器]
GREE --> GQE[图谱查询引擎]
GQE --> Neo4j[Neo4j数据库]
VR --> VectorDB[向量数据库]
GREE --> LLM[大语言模型]
LLM --> Answer[最终答案]
style GQE fill:#f9f,stroke:#333
style Neo4j fill:#f96,stroke:#333
```

**图表来源**
- [graphrag_engine.py](file://backend/graphrag_engine.py#L1-L484)
- [graph_query.py](file://backend/graph_query.py#L1-L436)

## 详细组件分析

### 图谱查询引擎分析
`GraphQueryEngine`是图谱查询功能的核心实现，它直接与Neo4j数据库交互，提供多种查询接口。

#### 类图
``mermaid
classDiagram
class GraphQueryEngine {
+string uri
+string username
+string password
+int top_k
+driver
+__init__()
+_initialize_connection()
+query_entities_by_name(entity_names List[str]) List[Dict]
+query_policies_by_entities(entity_names List[str]) List[Dict]
+query_entity_relationships(entity_name str, max_hops int) Dict
+search_similar_policies(query_text str) List[Dict]
+get_policy_context(policy_title str) Dict
+verify_entity_relations(entities List[str], relations List[str]) List[Dict]
+get_graph_statistics() Dict
+close()
}
GraphQueryEngine --> "1" Neo4j : "使用"
```

**图表来源**
- [graph_query.py](file://backend/graph_query.py#L14-L391)

**章节来源**
- [graph_query.py](file://backend/graph_query.py#L14-L391)

### GraphRAG引擎集成分析
`GraphRAGEngine`是整个系统的中枢，它负责协调各个组件，实现图谱增强的问答功能。

#### 序列图
``mermaid
sequenceDiagram
participant User as "用户"
participant API as "API服务器"
participant GRE as "GraphRAG引擎"
participant GQE as "图谱查询引擎"
participant Neo4j as "Neo4j数据库"
User->>API : 提交问题
API->>GRE : 调用answer_question()
GRE->>GRE : 提取问题实体
GRE->>GQE : 调用query_entities_by_name()
GQE->>Neo4j : 执行Cypher查询
Neo4j-->>GQE : 返回实体数据
GQE-->>GRE : 返回相关实体
GRE->>GQE : 调用query_policies_by_entities()
GQE->>Neo4j : 执行Cypher查询
Neo4j-->>GQE : 返回政策数据
GQE-->>GRE : 返回相关政策
GRE->>GRE : 构建增强上下文
GRE-->>API : 返回最终结果
API-->>User : 显示答案
```

**图表来源**
- [graphrag_engine.py](file://backend/graphrag_engine.py#L1-L484)
- [graph_query.py](file://backend/graph_query.py#L1-L436)

**章节来源**
- [graphrag_engine.py](file://backend/graphrag_engine.py#L1-L484)

## 依赖分析
图谱查询功能依赖于多个外部组件和库。最主要的依赖是Neo4j Python驱动，它负责与图数据库建立连接和执行查询。系统通过`connections.py`中的`ConnectionManager`进行统一管理，确保连接的稳定性和健康状态。此外，`GraphQueryEngine`还依赖于`dotenv`库来加载环境变量，以及`logging`库进行日志记录。`GraphRAGEngine`则依赖于`GraphQueryEngine`来获取图谱数据。

``mermaid
graph TD
GQE[GraphQueryEngine] --> Neo4jDriver[neo4j]
GQE --> Dotenv[dotenv]
GQE --> Logging[logging]
GQE --> OS[os]
GQE --> Typing[typing]
GQE --> GraphRAGEngine
GraphRAGEngine --> GQE
GraphRAGEngine --> VectorRetriever
GraphRAGEngine --> EntityExtractor
GraphRAGEngine --> HallucinationDetector
```

**图表来源**
- [graph_query.py](file://backend/graph_query.py#L1-L436)
- [graphrag_engine.py](file://backend/graphrag_engine.py#L1-L484)

**章节来源**
- [graph_query.py](file://backend/graph_query.py#L1-L436)
- [graphrag_engine.py](file://backend/graphrag_engine.py#L1-L484)

## 性能考虑
图谱查询功能在设计时充分考虑了性能因素。首先，通过连接池管理器（`Neo4jConnectionManager`）复用数据库连接，避免了频繁创建和销毁连接的开销。其次，所有查询都设置了合理的`LIMIT`子句，防止返回过多数据导致内存溢出。例如，`query_entities_by_name`方法会根据`top_k`参数限制返回结果的数量。此外，`query_entity_relationships`方法通过`max_hops`参数控制查询的深度，避免了过长的路径查询。在`GraphRAGEngine`中，为了避免过载，只对问题中的第一个实体查询其关系网络。

**章节来源**
- [graph_query.py](file://backend/graph_query.py#L1-L436)
- [connections.py](file://backend/connections.py#L1-L545)

## 故障排除指南
当图谱查询功能出现问题时，可以按照以下步骤进行排查：

1.  **检查Neo4j服务状态**：确保Neo4j数据库服务正在运行。
2.  **验证连接配置**：检查环境变量`NEO4J_URI`、`NEO4J_USERNAME`和`NEO4J_PASSWORD`是否正确。
3.  **查看日志信息**：检查系统日志，寻找与`Neo4j连接失败`或`查询执行失败`相关的错误信息。
4.  **测试连接**：运行`scripts/test_neo4j_connection.py`脚本，验证基本连接是否成功。
5.  **检查查询语句**：如果特定查询失败，检查Cypher语句的语法和逻辑是否正确。

**章节来源**
- [test_neo4j_connection.py](file://scripts/test_neo4j_connection.py#L1-L24)
- [graph_query.py](file://backend/graph_query.py#L1-L436)

## 结论
图谱查询功能是政策法规RAG问答系统的核心组成部分，它通过与Neo4j图数据库的深度集成，为系统提供了强大的结构化信息检索能力。该功能设计合理，通过`GraphQueryEngine`类提供了清晰的查询接口，并通过`GraphRAGEngine`与向量检索等其他模块无缝集成，共同构建了一个高效、准确的问答系统。未来可以通过创建数据库索引、优化Cypher查询等方式进一步提升性能。