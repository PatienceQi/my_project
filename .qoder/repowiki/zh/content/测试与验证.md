# 测试与验证

<cite>
**本文档引用的文件**  
- [test_neo4j_connection.py](file://scripts/test_neo4j_connection.py)
- [test_ollama_connection.py](file://scripts/test_ollama_connection.py) - *超时配置已更新*
- [test_backend_response.py](file://scripts/test_backend_response.py)
- [README.md](file://README.md)
- [requirements.txt](file://requirements.txt)
- [超时配置调整总结.md](file://超时配置调整总结.md) - *新增引用，说明超时变更背景*
</cite>

## 更新摘要
**变更内容**  
- 更新了 `test_ollama_connection.py` 脚本的超时配置说明，从30秒调整为600秒
- 在“运行方法与预期输出”和“测试结果解释”部分增加了关于超时设置的说明
- 新增了“超时配置变更说明”章节，详细解释最近的超时调整
- 所有受影响的测试脚本和后端组件均已更新文档
- 更新了文档引用来源，包含新的配置说明文件

## 目录
1. [测试与验证概述](#测试与验证概述)  
2. [测试脚本用途详解](#测试脚本用途详解)  
3. [运行方法与预期输出](#运行方法与预期输出)  
4. [测试结果解释](#测试结果解释)  
5. [部署后验证建议](#部署后验证建议)  
6. [配置修改后的测试建议](#配置修改后的测试建议)
7. [超时配置变更说明](#超时配置变更说明)

## 测试与验证概述

为确保政策法规RAG问答系统的稳定运行，开发者需在部署后或配置变更后验证系统各核心组件的健康状态。系统提供了三个关键测试脚本，分别用于验证与Neo4j数据库、Ollama大模型服务以及后端Flask API的连接。这些测试是确保系统功能正常的基础，应在任何部署或配置调整后执行。

**Section sources**
- [README.md](file://README.md#L13-L229)

## 测试脚本用途详解

### test_neo4j_connection.py：验证Neo4j数据库连接

此脚本用于测试与Neo4j图数据库的连接是否正常。它从环境变量中读取连接信息（URI、用户名、密码），尝试建立连接。如果连接成功，表明数据库服务已启动且凭据正确；如果失败，则可能意味着数据库未运行、网络不通或认证信息有误。

### test_ollama_connection.py：验证Ollama服务连接

此脚本用于测试Ollama大模型服务的可达性和模型响应能力。它会向Ollama服务发送一个简单的问候消息，并等待模型返回响应。此测试验证了外部AI服务的可用性，是系统生成自然语言回答的前提。**注意：该脚本的请求超时时间已从30秒调整为600秒，以适应远程Ollama服务的响应特性。**

### test_backend_response.py：验证后端API响应

此脚本用于检查Flask后端API是否能正确处理请求并返回问答结果。它会向后端的问答接口发送一个测试问题，并验证返回的响应格式和内容。此测试确保了前后端交互的完整性。

**Section sources**
- [scripts/README.md](file://scripts/README.md#L0-L8)

## 运行方法与预期输出

所有测试脚本均位于`scripts/`目录下，可通过Python命令直接运行。

### 运行方法

在项目根目录下，依次执行以下命令：

```bash
python scripts/test_neo4j_connection.py
python scripts/test_ollama_connection.py
python scripts/test_backend_response.py
```

### 预期输出

#### test_neo4j_connection.py
- **成功输出**：`Connection to Neo4j successful!`
- **失败输出**：`Failed to connect to Neo4j: <具体错误信息>`

#### test_ollama_connection.py
- **成功输出**：
  ```
  Connection successful! Response from ollama:
  <模型返回的问候语>
  ```
- **失败输出**：`Error connecting to ollama service: <具体错误信息>`

#### test_backend_response.py
- **成功输出**：`Backend API test passed. Response: <从API获取的回答>`
- **失败输出**：`Error: <具体错误信息>`

**Section sources**
- [README.md](file://README.md#L13-L229)

## 测试结果解释

理解测试结果对于快速诊断问题至关重要。

- **连接超时**：通常意味着目标服务（如Neo4j或Ollama）未启动，或网络配置有误（如IP地址或端口错误）。**特别注意：`test_ollama_connection.py`的超时时间已调整为600秒，如果在600秒内仍未收到响应，则判定为超时。**
- **认证失败**：表明提供的用户名或密码不正确，需要检查`.env`文件中的`NEO4J_USERNAME`和`NEO4J_PASSWORD`等变量。
- **服务不可达**：可能由于防火墙阻止、服务未监听指定端口，或`LLM_BINDING_HOST`指向的地址无效。
- **API返回错误**：`test_backend_response.py`失败可能是因为后端服务未启动，或后端在连接数据库或Ollama服务时出现问题。

**Section sources**
- [README.md](file://README.md#L13-L229)

## 部署后验证建议

建议将这三个测试脚本作为部署后的必经验证步骤。在完成以下操作后，必须运行完整的测试套件：

1.  **首次部署系统**：在安装依赖、配置环境变量、启动所有服务后。
2.  **服务器重启后**：确保所有服务（Neo4j, Ollama, Flask）都已随系统启动。
3.  **服务迁移或更新后**：当系统被迁移到新服务器或关键组件（如数据库、大模型）升级后。

通过执行`python scripts/test_*.py`这一系列命令，可以快速确认整个系统的健康状况，避免因单个组件故障导致系统无法使用。

**Section sources**
- [README.md](file://README.md#L13-L229)

## 配置修改后的测试建议

强烈建议开发者在修改任何配置后重新运行测试套件，以确保系统稳定性。需要重新测试的场景包括：

- **修改`.env`文件**：当更新了数据库连接信息、Ollama服务地址或模型名称时。
- **更改服务端口**：如果调整了Neo4j或Ollama服务的监听端口。
- **更新依赖包**：在执行`pip install -r requirements.txt`更新Python包后，以防出现兼容性问题。

重新运行测试套件是验证配置变更是否生效且未引入新问题的最直接方法，有助于在问题影响用户前及时发现并解决。

**Section sources**
- [README.md](file://README.md#L248-L252)

## 超时配置变更说明

根据最新的代码变更，系统中与Ollama服务相关的超时配置已统一调整为600秒（10分钟），以解决因远程服务响应延迟导致的连接超时问题。

### 变更详情

- **`test_ollama_connection.py`**：HTTP POST请求的超时时间从30秒增加到600秒，确保有足够时间等待远程Ollama服务的响应。
- **后端组件**：`OllamaConnectionManager`的默认超时参数已从120秒调整为600秒，`graphrag_engine.py`和`vector_retrieval.py`等模块的API调用也相应调整。
- **其他测试脚本**：`test_enhanced_features.py`中的会话管理API测试等也已更新为600秒超时。

### 变更原因

- **解决超时错误**：原30秒超时在远程服务响应较慢时频繁触发`Read timed out`异常。
- **提高稳定性**：更长的超时时间增强了系统对网络波动和模型推理延迟的容忍度。
- **保持健康检查快速**：与之相对，健康检查类操作（如`/health`端点）仍保持10秒以内的短超时，以确保快速反馈。

### 影响说明

- **测试执行时间**：`test_ollama_connection.py`脚本在连接失败时可能需要等待长达600秒才会报错。
- **资源占用**：长时间的连接可能会增加内存和连接池的使用。
- **监控建议**：建议监控API的实际响应时间分布，以便后续优化超时值。

**Section sources**
- [test_ollama_connection.py](file://scripts/test_ollama_connection.py#L35) - *超时配置已更新至600秒*
- [超时配置调整总结.md](file://超时配置调整总结.md) - *详细记录了所有超时配置的变更*
- [backend/connections.py](file://backend/connections.py#L167) - *Ollama连接管理器默认超时参数*
- [backend/ollama_error_handler.py](file://backend/ollama_error_handler.py#L132) - *错误处理器中的超时设置*