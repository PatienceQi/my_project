# 核心功能模块

<cite>
**本文档引用的文件**
- [index.html](file://frontend/index.html)
- [api_server.py](file://backend/api_server.py)
- [华侨经济文化合作试验区.json](file://database/华侨经济文化合作试验区.json)
- [import_policy_data.py](file://scripts/import_policy_data.py)
- [test_backend_response.py](file://scripts/test_backend_response.py)
- [test_neo4j_connection.py](file://scripts/test_neo4j_connection.py)
- [graphrag_engine.py](file://backend/graphrag_engine.py)
</cite>

## 更新摘要
**已做更改**
- 更新了核心功能分析，新增了GraphRAG引擎和增强问答API的描述
- 更新了系统架构概述，增加了GraphRAG处理流程
- 更新了后端组件分析，详细说明了GraphRAG引擎的集成
- 更新了典型查询流程示例，增加了GraphRAG模式的处理流程
- 更新了前端组件分析，反映了多轮对话支持和页脚变更
- 新增了GraphRAG引擎组件分析章节
- 新增了对比分析功能章节

## 目录
1. [项目结构](#项目结构)
2. [核心功能分析](#核心功能分析)
3. [系统架构概述](#系统架构概述)
4. [详细组件分析](#详细组件分析)
5. [数据处理与导入流程](#数据处理与导入流程)
6. [典型查询流程示例](#典型查询流程示例)
7. [测试与验证](#测试与验证)

## 项目结构
本系统采用前后端分离的架构设计，主要由以下模块构成：
- **前端模块 (frontend/)**：包含用户界面文件，核心为`index.html`，提供用户交互界面。
- **后端模块 (backend/)**：基于Flask框架的API服务，核心为`api_server.py`，负责处理业务逻辑。
- **数据库模块 (database/)**：存储原始政策法规数据，采用JSON格式。
- **脚本模块 (scripts/)**：包含数据导入、连接测试等辅助工具脚本。

``mermaid
graph TB
subgraph "前端"
UI[index.html]
end
subgraph "后端"
API[api_server.py]
DB[(Neo4j)]
end
subgraph "数据与脚本"
Data[华侨经济文化合作试验区.json]
Scripts[import_policy_data.py]
end
UI --> API
API --> DB
Scripts --> DB
Scripts --> Data
```

**图源**
- [index.html](file://frontend/index.html)
- [api_server.py](file://backend/api_server.py)
- [import_policy_data.py](file://scripts/import_policy_data.py)

**本节来源**
- [index.html](file://frontend/index.html)
- [api_server.py](file://backend/api_server.py)

## 核心功能分析
系统实现了三大核心功能：自然语言问答、答案溯源和实体关系展示。近期更新引入了GraphRAG引擎，显著提升了问答系统的准确性和可解释性。

### 自然语言问答
用户在前端输入自然语言问题，系统通过后端API进行处理。后端服务接收问题后，首先在Neo4j图数据库中检索相关联的政策条款，然后将检索到的上下文信息与用户问题一起构造成提示词（prompt），发送给大语言模型（LLM）进行处理。LLM生成易于理解的自然语言回答后，返回给前端展示。

系统现在支持两种问答模式：传统RAG模式和GraphRAG增强模式。GraphRAG模式整合了向量检索和图谱查询，通过实体提取和幻觉检测，提供更准确、更可靠的答案。

### 答案溯源
系统不仅返回答案，还提供引用的政策原文段落和章节路径。当后端从Neo4j数据库检索到相关信息时，会将政策标题、章节标题、发布机构等元数据与内容一并返回。前端在展示答案时，会将这些元数据以列表形式呈现，使用户能够追溯答案的来源，极大增强了结果的可信度。

在GraphRAG模式下，系统还提供详细的来源信息，包括文档来源和图谱来源，并给出答案的可信度评分和风险等级。

### 实体关系展示
系统利用Neo4j图数据库的特性，将政策法规中的实体（如政策、章节、发布机构）及其关系（如“发布”、“属于”）进行结构化存储。这使得系统能够可视化展示政策发布机构、政策类别、修订关系等复杂关联，为用户提供更深入的理解。

**本节来源**
- [index.html](file://frontend/index.html)
- [api_server.py](file://backend/api_server.py)
- [graphrag_engine.py](file://backend/graphrag_engine.py)

## 系统架构概述
系统采用典型的三层架构：前端展示层、后端服务层和数据存储层。近期更新引入了GraphRAG引擎，增强了系统的问答能力。

``mermaid
sequenceDiagram
participant 用户 as "用户"
participant 前端 as "前端 (index.html)"
participant 后端 as "后端 (api_server.py)"
participant 数据库 as "Neo4j数据库"
participant 大模型 as "Ollama大模型"
用户->>前端 : 输入问题
前端->>后端 : POST /api/ask (问题)
后端->>数据库 : 查询相关政策
数据库-->>后端 : 返回政策数据
后端->>大模型 : 发送Prompt (上下文+问题)
大模型-->>后端 : 返回生成的回答
后端-->>前端 : 返回答案和实体信息
前端->>用户 : 展示答案和溯源信息
```

对于GraphRAG增强模式，处理流程如下：

``mermaid
sequenceDiagram
participant 用户 as "用户"
participant 前端 as "前端 (index.html)"
participant 后端 as "后端 (api_server.py)"
participant GraphRAG as "GraphRAG引擎"
participant 向量库 as "向量数据库"
participant 图数据库 as "Neo4j图数据库"
participant 大模型 as "Ollama大模型"
用户->>前端 : 输入问题
前端->>后端 : POST /api/ask/enhanced (问题)
后端->>GraphRAG : 调用answer_question
GraphRAG->>图数据库 : 查询实体关系
图数据库-->>GraphRAG : 返回图谱上下文
GraphRAG->>向量库 : 执行向量检索
向量库-->>GraphRAG : 返回相关文档
GraphRAG->>GraphRAG : 构建增强上下文
GraphRAG->>大模型 : 发送Prompt (增强上下文+问题)
大模型-->>GraphRAG : 返回生成的回答
GraphRAG->>GraphRAG : 执行幻觉检测
GraphRAG-->>后端 : 返回答案、可信度、来源等信息
后端-->>前端 : 返回完整响应
前端->>用户 : 展示答案、可信度和溯源信息
```

**图源**
- [index.html](file://frontend/index.html)
- [api_server.py](file://backend/api_server.py)
- [graphrag_engine.py](file://backend/graphrag_engine.py)

**本节来源**
- [index.html](file://frontend/index.html)
- [api_server.py](file://backend/api_server.py)
- [graphrag_engine.py](file://backend/graphrag_engine.py)

## 详细组件分析

### 前端组件分析
前端由`index.html`文件实现，包含一个简洁的聊天界面。用户在输入框中输入问题后，点击“发送”按钮或按回车键，JavaScript代码会通过`fetch` API向后端`/api/ask`接口发送POST请求。

前端支持多轮对话功能，通过会话ID管理对话历史。用户可以创建新会话、清空聊天记录，并查看当前会话状态。

``mermaid
flowchart TD
Start([用户输入问题]) --> SendRequest["发送POST请求到/api/ask"]
SendRequest --> CheckConnection{"后端是否连接?"}
CheckConnection --> |否| ShowError["显示'后端服务未连接'"]
CheckConnection --> |是| ShowUserMsg["显示用户消息"]
ShowUserMsg --> CallAPI["调用后端API"]
CallAPI --> ReceiveData{"收到响应?"}
ReceiveData --> |否| HandleError["显示错误信息"]
ReceiveData --> |是| ProcessData["解析回答和实体信息"]
ProcessData --> DisplayAnswer["在聊天框显示回答"]
ProcessData --> DisplayEntities["以列表形式显示相关政策法规"]
DisplayAnswer --> End([结束])
DisplayEntities --> End
ShowError --> End
HandleError --> End
```

**图源**
- [index.html](file://frontend/index.html)

**本节来源**
- [index.html](file://frontend/index.html)

### 后端组件分析
后端核心逻辑在`api_server.py`中实现。`/api/ask`接口接收用户问题，调用`generate_policy_answer`函数进行处理。

该函数首先通过`query_neo4j`事务函数在Neo4j中执行Cypher查询，检索与问题相关的政策信息。查询逻辑是匹配政策标题、章节标题或子章节标题中包含问题关键词的记录。

系统还引入了`/api/ask/enhanced`接口，用于支持GraphRAG增强问答。该接口调用`GraphRAGEngine`的`answer_question`方法，整合向量检索和图谱查询，提供更准确的答案。

``mermaid
classDiagram
class FlaskApp {
+app : Flask
+CORS : CORS
+driver : GraphDatabase.driver
+client : ollama.Client
}
class get_policy_answer {
+question : str
+neo4j_results : list
+context : str
+results : list
+prompt : str
+response : dict
}
class query_neo4j {
+tx : Transaction
+query_text : str
+result : list
}
class GraphRAGEngine {
+answer_question()
+_query_graph_context()
+_build_enhanced_context()
+_generate_answer()
}
FlaskApp --> get_policy_answer : "调用"
FlaskApp --> query_neo4j : "调用"
get_policy_answer --> query_neo4j : "作为事务执行"
FlaskApp --> GraphRAGEngine : "调用"
```

**图源**
- [api_server.py](file://backend/api_server.py)
- [graphrag_engine.py](file://backend/graphrag_engine.py)

**本节来源**
- [api_server.py](file://backend/api_server.py)
- [graphrag_engine.py](file://backend/graphrag_engine.py)

### GraphRAG引擎组件分析
`backend/graphrag_engine.py`文件实现了GraphRAG引擎，整合了向量检索、图谱查询、实体提取和幻觉检测等模块，提供统一的问答接口。

#### 核心类
`GraphRAGEngine`类是GraphRAG引擎的核心，其主要功能包括：
- **初始化**：加载环境变量，初始化向量检索器、图谱查询引擎、实体提取器和幻觉检测器。
- **问答处理**：`answer_question`方法是主要接口，处理用户问题并返回答案。
- **上下文构建**：`_build_enhanced_context`方法整合向量检索和图谱查询结果，构建增强上下文。
- **答案生成**：`_generate_answer`方法调用Ollama大模型生成答案。
- **幻觉检测**：`detect_hallucination`方法检测生成答案的可靠性。

#### 处理流程
1. **问题预处理**：从用户问题中提取关键实体。
2. **并行检索**：同时执行向量检索和图谱查询。
3. **上下文构建**：整合检索结果，构建增强上下文。
4. **答案生成**：将增强上下文和问题发送给大模型生成答案。
5. **幻觉检测**：检测生成答案的可靠性，提供可信度评分。
6. **响应构建**：返回包含答案、可信度、来源等信息的完整响应。

**本节来源**
- [graphrag_engine.py](file://backend/graphrag_engine.py)

## 数据处理与导入流程
原始政策数据以JSON格式存储在`database/华侨经济文化合作试验区.json`文件中，其结构清晰，包含政策标题、章节和条款。

```json
{
  "title": "华侨经济文化合作试验区深汕数字科创产业园\n\n运营管理办法",
  "chapters": [
    {
      "title": "总则",
      "number": "第一章",
      "articles": [
        {
          "number": "第一条",
          "content": "为贯彻市委、市政府决策部署..."
        }
      ]
    }
  ]
}
```

`scripts/import_policy_data.py`脚本负责将此JSON数据导入Neo4j数据库。该脚本读取JSON文件，遍历其章节和条款，为每个政策、章节创建对应的节点，并建立“属于”（BELONGS_TO）关系。同时，脚本还调用大模型服务进行实体识别和关系抽取，将识别出的实体（如机构名称）和关系（如“发布”）也存入图数据库。

**本节来源**
- [华侨经济文化合作试验区.json](file://database/华侨经济文化合作试验区.json)
- [import_policy_data.py](file://scripts/import_policy_data.py)

## 典型查询流程示例
以用户查询“华侨经济文化合作试验区有哪些税收优惠政策？”为例，系统处理流程如下：

1.  **前端输入**：用户在`index.html`的输入框中输入问题。
2.  **API调用**：前端JavaScript代码将问题作为JSON数据发送到`http://127.0.0.1:5000/api/ask`。
3.  **数据库检索**：后端`api_server.py`接收到请求，执行Cypher查询，查找标题或内容中包含“税收优惠”关键词的政策条款。
4.  **上下文构建**：后端将检索到的政策条款内容（如“第五条 入驻条件...”）整理成上下文字符串。
5.  **大模型生成**：后端将上下文和用户问题构造成Prompt，发送给Ollama大模型。
6.  **答案返回**：大模型生成回答，后端将答案和引用的政策信息（实体）一并返回给前端。
7.  **前端展示**：前端在聊天界面中显示大模型生成的答案，并列出引用的政策原文。

在GraphRAG模式下，处理流程如下：

1.  **前端输入**：用户在`index.html`的输入框中输入问题。
2.  **API调用**：前端JavaScript代码将问题作为JSON数据发送到`http://127.0.0.1:5000/api/ask/enhanced`。
3.  **实体提取**：GraphRAG引擎从问题中提取关键实体（如“华侨经济文化合作试验区”、“税收优惠”）。
4.  **并行检索**：同时执行向量检索和图谱查询。
5.  **上下文构建**：整合向量检索和图谱查询结果，构建增强上下文。
6.  **大模型生成**：将增强上下文和问题发送给Ollama大模型生成答案。
7.  **幻觉检测**：检测生成答案的可靠性，提供可信度评分。
8.  **答案返回**：后端将答案、可信度、来源等信息一并返回给前端。
9.  **前端展示**：前端在聊天界面中显示大模型生成的答案、可信度评分和详细的溯源信息。

**本节来源**
- [index.html](file://frontend/index.html)
- [api_server.py](file://backend/api_server.py)
- [graphrag_engine.py](file://backend/graphrag_engine.py)

## 测试与验证
项目提供了多个测试脚本用于验证系统各组件的健康状态。

`scripts/test_neo4j_connection.py`脚本用于测试与Neo4j数据库的连接。它读取环境变量中的URI、用户名和密码，尝试创建驱动程序并建立连接，成功则打印“Connection to Neo4j successful!”。

`scripts/test_backend_response.py`脚本用于测试后端API的响应。它向`/api/ask`接口发送一个测试问题（如“汕华管委规第一章第一条的主要内容是什么”），并打印返回的答案和完整数据，以验证后端服务是否正常工作。

系统还提供了`/api/compare`接口，用于对比传统RAG和GraphRAG的回答。该接口接收一个用户问题，分别调用传统RAG和GraphRAG模式生成答案，并返回对比分析结果。

``mermaid
flowchart LR
A[启动Neo4j] --> B[运行test_neo4j_connection.py]
B --> C{连接成功?}
C --> |是| D[启动后端服务]
D --> E[运行import_policy_data.py]
E --> F[运行test_backend_response.py]
F --> G{返回有效答案?}
G --> |是| H[系统准备就绪]
C --> |否| I[检查配置和日志]
G --> |否| J[检查后端日志和数据]
```

**图源**
- [test_neo4j_connection.py](file://scripts/test_neo4j_connection.py)
- [test_backend_response.py](file://scripts/test_backend_response.py)

**本节来源**
- [test_neo4j_connection.py](file://scripts/test_neo4j_connection.py)
- [test_backend_response.py](file://scripts/test_backend_response.py)