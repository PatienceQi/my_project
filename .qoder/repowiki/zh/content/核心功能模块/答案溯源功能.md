# 答案溯源功能

<cite>
**本文档引用文件**  
- [api_server.py](file://backend/api_server.py#L1-L150)
- [index.html](file://frontend/index.html#L1-L250)
- [README.md](file://README.md#L1-L252)
- [软件著作权申请.md](file://软件著作权申请.md#L1-L190)
- [import_policy_data.py](file://scripts/import_policy_data.py#L1-L533)
</cite>

## 目录
1. [项目概述](#项目概述)
2. [答案溯源机制](#答案溯源机制)
3. [后端实现逻辑](#后端实现逻辑)
4. [前端展示方式](#前端展示方式)
5. [响应结构示例](#响应结构示例)
6. [引用处理策略](#引用处理策略)
7. [用户验证场景](#用户验证场景)

## 项目概述

本项目为“政策法规RAG问答系统Demo”，旨在通过结合大语言模型（Ollama）与Neo4j图数据库，构建一个智能、可信的政策法规问答平台。系统支持多模态查询、实体关系可视化，并具备核心的**答案溯源功能**，确保生成的回答均有明确的政策依据，提升结果的权威性与可信度。

该系统采用前后端分离架构：
- **前端**：基于HTML/CSS/JavaScript实现用户交互界面。
- **后端**：基于Python Flask框架，负责处理用户请求、调用大模型并从Neo4j数据库检索数据。
- **数据库**：使用Neo4j图数据库存储政策法规的结构化信息，包括政策、章节、条款及发布机构等实体及其关系。

**答案溯源功能**是本系统的核心特色之一，其设计目标是为每一个由大模型生成的回答提供可验证的原始政策依据，实现“有据可查”。

**Section sources**
- [README.md](file://README.md#L1-L252)
- [软件著作权申请.md](file://软件著作权申请.md#L1-L190)

## 答案溯源机制

答案溯源功能的核心在于**将大模型的生成式回答与图数据库中的原始政策节点进行关联**。当用户提出问题时，系统并非直接依赖大模型的“幻觉”或通用知识，而是先从Neo4j数据库中检索出与问题相关的政策片段，再将这些片段作为上下文（context）输入给大模型，引导其生成基于事实的回答。同时，系统会记录下这些被引用的原始政策节点信息，并随回答一同返回给前端。

这一机制确保了：
1. **回答的准确性**：回答内容基于真实的政策文本。
2. **结果的可验证性**：用户可以查看回答所依据的具体政策条款。
3. **系统的透明度**：明确了信息来源，避免了“黑箱”操作。

**Section sources**
- [软件著作权申请.md](file://软件著作权申请.md#L1-L190)

## 后端实现逻辑

### Neo4j查询与数据提取

后端在`backend/api_server.py`文件中定义了`query_neo4j`函数，用于从Neo4j数据库中检索与用户问题相关的政策信息。

```python
def query_neo4j(tx, query_text):
    query = (
        "MATCH (p:Policy) "
        "OPTIONAL MATCH (p)-[:HAS_SECTION]->(s:Section) "
        "OPTIONAL MATCH (s)-[:CONTAINS]->(sub:SubSection) "
        "OPTIONAL MATCH (p)-[:ISSUED_BY]->(a:Agency) "
        "WHERE p.title CONTAINS $query_text OR s.title CONTAINS $query_text OR sub.title CONTAINS $query_text "
        "RETURN p.title as policy_title, p.publish_agency as agency, s.title as section_title, s.content as section_content, sub.title as sub_title, sub.content as sub_content, a.name as agency_name "
        "LIMIT 5"
    )
    result = tx.run(query, query_text=query_text).data()
    return result
```

此Cypher查询语句会匹配以下信息：
- **政策标题** (`p.title`)
- **发布机构** (`a.name`)
- **章节标题** (`s.title`) 和 **章节内容** (`s.content`)
- **条款标题** (`sub.title`) 和 **条款内容** (`sub.content`)

查询结果以字典列表的形式返回，每个字典（`record`）代表一个匹配的政策片段。

### 构建响应对象

在`get_policy_answer`函数中，系统遍历`neo4j_results`，从每个`record`中提取信息，并构建用于大模型的上下文（`context`）以及用于前端展示的溯源信息（`results`）。

```python
for record in neo4j_results:
    policy_title = record.get('policy_title', '未知政策')
    section_title = record.get('section_title', '')
    section_content = record.get('section_content', '内容暂无')
    sub_title = record.get('sub_title', '')
    sub_content = record.get('sub_content', '内容暂无')
    agency_name = record.get('agency_name', '未知机构')
    
    # 构建大模型的上下文
    context += f"政策标题: {policy_title}\n"
    if section_title:
        context += f"章节标题: {section_title}\n"
        context += f"章节内容: {section_content}\n"
    if sub_title:
        context += f"条款标题: {sub_title}\n"
        context += f"条款内容: {sub_content}\n"
    context += f"发布机构: {agency_name}\n\n"
    
    # 为前端构建溯源信息
    content_to_display = sub_content if sub_content != '内容暂无' else section_content
    results.append({
        "policy_title": policy_title,
        "section_title": section_title if section_title else sub_title,
        "content": content_to_display,
        "agency": agency_name,
        "relation": "发布单位"
    })
```

**关键逻辑解析**：
1. **字段提取**：使用`record.get()`方法安全地从数据库查询结果中提取`policy_title`、`section_path`（在代码中体现为`section_title`和`sub_title`）和`content_snippet`（在代码中体现为`section_content`或`sub_content`）。
2. **内容优先级**：通过`content_to_display = sub_content if sub_content != '内容暂无' else section_content`，系统优先选择更具体的**条款内容**作为溯源文本，若无则回退到**章节内容**。
3. **构建溯源数组**：`results`数组中的每个对象都包含了`policy_title`、`section_title`、`content`、`agency`和`relation`字段，这些信息将作为`entities`字段返回给前端。

**Section sources**
- [api_server.py](file://backend/api_server.py#L1-L150)

## 前端展示方式

前端在`frontend/index.html`中负责解析后端返回的响应，并以用户友好的方式展示答案及其溯源信息。

```javascript
const data = await response.json();
const botMsg = document.createElement('div');
botMsg.className = 'message bot-message';

// 显示回答内容
botMsg.innerHTML = `<strong>回答:</strong> ${data.answer.replace(/\n/g, '<br>')}`;

// 如果有实体信息，展示实体和关系
if (data.entities && data.entities.length > 0) {
    botMsg.innerHTML += `<br><strong>相关政策法规:</strong>`;
    const entityList = document.createElement('ul');
    data.entities.forEach(entity => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `<strong>${entity.policy_title}</strong> - ${entity.section_title} （发布单位: ${entity.agency}）`;
        entityList.appendChild(listItem);
    });
    botMsg.appendChild(entityList);
}
```

**展示逻辑**：
1. **回答内容**：将`data.answer`字段的内容以“回答:”为前缀展示，并将换行符`\n`替换为HTML的`<br>`标签以保证格式。
2. **溯源信息**：如果响应中包含`entities`数组且不为空，则在回答下方以“相关政策法规:”为标题，创建一个无序列表（`<ul>`）。
3. **信息条目**：对于`entities`数组中的每一项，创建一个列表项（`<li>`），展示其`policy_title`、`section_title`和`agency`（发布单位）。

这种设计将溯源信息以**引用块**的形式清晰地呈现出来，与主回答内容区分开，便于用户查阅。

**Section sources**
- [index.html](file://frontend/index.html#L1-L250)

## 响应结构示例

一个典型的包含答案溯源信息的JSON响应结构如下：

```json
{
  "answer": "根据《华侨经济文化合作试验区管理办法》第一章第一条，该试验区的设立旨在深化侨务工作改革，促进华侨华人与祖国的经济文化交流与合作，打造新时代全面深化改革开放的新标杆。",
  "entities": [
    {
      "policy_title": "华侨经济文化合作试验区管理办法",
      "section_title": "第一章 总则",
      "content": "第一条 为深化侨务工作改革，促进华侨华人与祖国的经济文化交流与合作，打造新时代全面深化改革开放的新标杆，特设立华侨经济文化合作试验区。",
      "agency": "国务院侨务办公室",
      "relation": "发布单位"
    },
    {
      "policy_title": "华侨经济文化合作试验区管理办法",
      "section_title": "第二条 试验区范围",
      "content": "第二条 华侨经济文化合作试验区的范围包括...（此处为具体范围描述）。",
      "agency": "国务院侨务办公室",
      "relation": "发布单位"
    }
  ]
}
```

此结构清晰地分为两部分：
- `answer`：由大模型生成的最终回答。
- `entities`：一个数组，包含所有被引用的政策依据。

**Section sources**
- [软件著作权申请.md](file://软件著作权申请.md#L1-L190)

## 引用处理策略

### 去重与排序

当前代码实现中，`entities`数组的构建是基于`neo4j_results`的顺序，直接将查询到的前5条记录（`LIMIT 5`）按顺序加入数组。**目前的实现并未包含显式的去重逻辑**。这意味着，如果同一个政策的不同章节被多次匹配，它们可能会作为多个条目出现在`entities`数组中。

**排序策略**：结果的排序由Neo4j查询的匹配逻辑决定。由于查询条件是`WHERE p.title CONTAINS $query_text OR s.title CONTAINS $query_text OR sub.title CONTAINS $query_text`，因此匹配到的记录顺序可能与关键词在标题中的匹配程度有关，但并非严格的优先级排序。

### 无明确来源的处理

如果`neo4j_results`为空，即数据库中未找到与问题相关的政策信息，`get_policy_answer`函数将不会构建`context`和`results`。在这种情况下，系统可能会：
1. 尝试直接调用大模型进行通用问答（当前代码片段未展示此逻辑）。
2. 返回一个预设的“未找到相关信息”提示。

在`results`数组为空时，前端的`if (data.entities && data.entities.length > 0)`判断将为`false`，因此不会显示“相关政策法规”部分，仅展示回答内容。

**Section sources**
- [api_server.py](file://backend/api_server.py#L1-L150)

## 用户验证场景

用户验证场景是答案溯源功能价值的直接体现。例如，当用户提问：“华侨经济文化合作试验区的设立目的是什么？”时，系统返回的答案会引用《华侨经济法规合作试验区管理办法》第一章第一条的具体内容。

**理想化的用户验证流程**：
1. 用户在前端看到回答和下方的溯源信息。
2. 用户点击溯源信息中的政策标题（如“华侨经济文化合作试验区管理办法”）。
3. 前端通过JavaScript事件监听，捕获点击事件。
4. 前端跳转至一个“政策全文”页面，该页面通过另一个API（如`/api/policy/full?title=...`）获取并展示该政策的完整文本。
5. 用户可以在全文中搜索“第一章第一条”，验证回答的准确性。

虽然当前提供的代码中未实现“点击跳转”功能，但`entities`数组中已包含了`policy_title`这一关键字段，为实现此功能提供了坚实的数据基础。

**Section sources**
- [index.html](file://frontend/index.html#L1-L250)
- [api_server.py](file://backend/api_server.py#L1-L150)